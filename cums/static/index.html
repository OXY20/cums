<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>文件上传系统</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; background-color: #f5f5f5; min-height: 100vh; }
        .header { background-color: #fff; box-shadow: 0 1px 3px rgba(0,0,0,0.1); padding: 16px 24px; display: flex; justify-content: space-between; align-items: center; }
        .header h1 { font-size: 18px; color: #333; font-weight: 500; }
        .user-info { display: flex; align-items: center; gap: 12px; }
        .user-info span { color: #666; font-size: 14px; }
        .nav-link { color: #666; text-decoration: none; font-size: 14px; padding: 8px 12px; border-radius: 4px; cursor: pointer; }
        .nav-link:hover { color: #1890ff; background-color: #e6f7ff; }
        .btn { padding: 8px 16px; border: none; border-radius: 4px; cursor: pointer; font-size: 14px; }
        .btn-primary { background-color: #1890ff; color: #fff; }
        .btn-primary:hover { background-color: #40a9ff; }
        .main { max-width: 600px; margin: 40px auto; padding: 0 20px; }
        .upload-card, .about-card { background-color: #fff; border-radius: 8px; padding: 32px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
        .about-card h2 { font-size: 16px; color: #333; margin-bottom: 24px; text-align: center; }
        .version-info { text-align: center; padding: 20px 0; border-bottom: 1px solid #f0f0f0; margin-bottom: 24px; }
        .version-info .version { font-size: 24px; color: #1890ff; font-weight: 500; }
        .version-info .date { font-size: 12px; color: #999; margin-top: 8px; }
        .changelog { max-height: 400px; overflow-y: auto; }
        .changelog h3 { font-size: 16px; color: #333; margin: 16px 0 8px; }
        .changelog ul { list-style: none; padding-left: 0; }
        .changelog li { position: relative; padding-left: 16px; margin-bottom: 8px; font-size: 14px; color: #666; line-height: 1.6; }
        .changelog li::before { content: "•"; position: absolute; left: 0; color: #1890ff; }
        .changelog .version-header { font-size: 16px; font-weight: 500; color: #333; margin-top: 24px; padding-bottom: 8px; border-bottom: 1px solid #e8e8e8; }
        .form-group { margin-bottom: 20px; }
        .form-group label { display: block; margin-bottom: 8px; color: #333; font-size: 14px; }
        .form-group select, .form-group input[type="text"] { width: 100%; padding: 10px 12px; border: 1px solid #d9d9d9; border-radius: 4px; font-size: 14px; }
        .form-group select:focus, .form-group input[type="text"]:focus { outline: none; border-color: #1890ff; }
        .form-group input[type="file"] { width: 100%; padding: 8px 12px; border: 1px solid #d9d9d9; border-radius: 4px; font-size: 14px; }
        .upload-btn { width: 100%; padding: 12px; background-color: #1890ff; color: #fff; border: none; border-radius: 4px; font-size: 16px; cursor: pointer; }
        .upload-btn:hover { background-color: #40a9ff; }
        .upload-btn:disabled { background-color: #d9d9d9; cursor: not-allowed; }
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.5); justify-content: center; align-items: center; z-index: 1000; }
        .modal.active { display: flex; }
        .modal-content { background-color: #fff; border-radius: 8px; padding: 24px; width: 360px; box-shadow: 0 4px 12px rgba(0,0,0,0.15); }
        .modal-content h3 { font-size: 16px; color: #333; margin-bottom: 20px; text-align: center; }
        .modal-close { float: right; cursor: pointer; color: #999; font-size: 20px; line-height: 1; }
        .modal-close:hover { color: #333; }
        .modal .btn-primary { width: 100%; padding: 10px; }
        .message { padding: 12px 16px; border-radius: 4px; margin-bottom: 20px; display: none; }
        .message.success { background-color: #f6ffed; border: 1px solid #b7eb8f; color: #52c41a; display: block; }
        .message.error { background-color: #fff2f0; border: 1px solid #ffccc7; color: #f5222d; display: block; }
        .hidden { display: none !important; }
        .welcome-text { color: #666; text-align: center; padding: 40px 0; }
        .welcome-text p { margin-bottom: 8px; font-size: 14px; }
        .welcome-text .btn { margin-top: 16px; }
        .loading { display: inline-block; width: 16px; height: 16px; border: 2px solid #fff; border-radius: 50%; border-top-color: transparent; animation: spin 0.8s linear infinite; margin-right: 8px; vertical-align: middle; }
        @keyframes spin { to { transform: rotate(360deg); } }
        .file-name { margin-top: 8px; font-size: 12px; color: #666; }
        .class-tag { display: inline-block; padding: 4px 12px; background-color: #e6f7ff; border: 1px solid #91d5ff; border-radius: 4px; color: #1890ff; font-size: 12px; margin-bottom: 16px; }
        .footer { text-align: center; padding: 20px; color: #999; font-size: 12px; }
        .footer a { color: #1890ff; text-decoration: none; }
        .footer a:hover { text-decoration: underline; }
    </style>
</head>
<body>
    <header class="header">
        <h1>文件上传系统</h1>
        <div class="user-info" id="userInfo">
            <a class="nav-link" onclick="showAboutPage()">关于</a>
            <button class="btn btn-primary" onclick="showLoginModal()">登录</button>
        </div>
    </header>
    <main class="main">
        <div class="upload-card" id="uploadCard">
            <div class="welcome-text" id="welcomeText">
                <p>请先登录</p>
                <button class="btn btn-primary" onclick="showLoginModal()">登录</button>
            </div>
            <div id="uploadForm" class="hidden">
                <div class="class-tag" id="classTag"></div>
                <h2>作业上传</h2>
                <div class="message" id="message"></div>
                <form id="fileUploadForm" onsubmit="handleUpload(event)">
                    <div class="form-group">
                        <label>科目</label>
                        <select id="subjectSelect" onchange="onSubjectChange()" required><option value="">请选择科目</option></select>
                    </div>
                    <div class="form-group">
                        <label>作业</label>
                        <select id="homeworkSelect" required><option value="">请选择作业</option></select>
                    </div>
                    <div class="form-group">
                        <label>文件</label>
                        <input type="file" id="fileInput" required>
                        <div class="file-name" id="fileName"></div>
                    </div>
                    <button type="submit" class="upload-btn" id="uploadBtn">上传文件</button>
                </form>
            </div>
        </div>
        <div class="about-card hidden" id="aboutCard">
            <h2>关于</h2>
            <div class="version-info">
                <div class="version" id="aboutVersion">v1.0.4</div>
                <div class="date">文件上传系统</div>
            </div>
            <div class="changelog" id="changelogContent"><p>加载中...</p></div>
        </div>
    </main>
    <footer class="footer">
        <a onclick="showAboutPage()">关于</a> &bull; <span id="footerVersion">v1.0.4</span>
    </footer>
    <div class="modal" id="loginModal">
        <div class="modal-content">
            <span class="modal-close" onclick="hideLoginModal()">&times;</span>
            <h3>用户登录</h3>
            <form onsubmit="handleLogin(event)">
                <div class="form-group">
                    <label>班级</label>
                    <select id="loginClass" required><option value="">请选择班级</option></select>
                </div>
                <div class="form-group">
                    <label>号数</label>
                    <input type="text" id="loginStudentId" placeholder="请输入号数" required>
                </div>
                <div class="form-group">
                    <label>姓名</label>
                    <input type="text" id="loginStudentName" placeholder="请输入姓名" required>
                </div>
                <button type="submit" class="btn btn-primary">登录</button>
            </form>
        </div>
    </div>
    <script>
        let currentUser = null, configData = null, currentVersion = '1.0.4';
        document.getElementById('fileInput').addEventListener('change', e => { document.getElementById('fileName').textContent = e.target.files[0]?.name || ''; });
        async function loadConfig() { try { const r = await fetch('/api/v1/config', { method: 'POST', headers: {'Content-Type': 'application/json'} }); const rs = await r.json(); if (rs.success) { configData = rs.data; initSubjectSelect(); initLoginClassSelect(); } } catch (e) { console.error('加载配置失败:', e); } }
        async function loadVersion() { try { const r = await fetch('/api/v1/version'); const rs = await r.json(); if (rs.success) { currentVersion = rs.version; document.getElementById('aboutVersion').textContent = 'v' + currentVersion; document.getElementById('footerVersion').textContent = 'v' + currentVersion; } } catch (e) { console.error('加载版本失败:', e); } }
        async function loadChangelog() { try { const r = await fetch('/api/v1/changelog'); const rs = await r.json(); if (rs.success) { document.getElementById('changelogContent').innerHTML = formatChangelog(rs.changelog); } } catch (e) { document.getElementById('changelogContent').innerHTML = '<p>加载失败</p>'; } }
        function formatChangelog(text) { const lines = text.split('\n'); let h = ''; let inList = false; for (let l of lines) { l = l.trim(); if (!l) continue; if (l.startsWith('# ')) { if (inList) { h += '</ul>'; inList = false; } h += '<h2>' + l.substring(2) + '</h2>'; } else if (l.startsWith('## ')) { if (inList) { h += '</ul>'; inList = false; } h += '<div class="version-header">' + l.substring(3) + '</div>'; } else if (l.startsWith('### ')) { if (inList) { h += '</ul>'; inList = false; } h += '<h3>' + l.substring(4) + '</h3>'; } else if (l.startsWith('- ') || l.startsWith('* ')) { if (!inList) { h += '<ul>'; inList = true; } h += '<li>' + l.substring(2) + '</li>'; } else { if (inList) { h += '</ul>'; inList = false; } h += '<p>' + l + '</p>'; } } if (inList) h += '</ul>'; return h; }
        function initSubjectSelect() { const s = document.getElementById('subjectSelect'); Object.keys(configData.subjects).forEach(sub => { s.add(new Option(sub, sub)); }); }
        function initLoginClassSelect() { const s = document.getElementById('loginClass'); const classes = new Set(); Object.values(configData.subjects).forEach(sub => { sub.classes.forEach(c => classes.add(c)); }); classes.forEach(c => { s.add(new Option(c, c)); }); }
        function onSubjectChange() { const subject = document.getElementById('subjectSelect').value; const hwSelect = document.getElementById('homeworkSelect'); const msg = document.getElementById('message'); hwSelect.innerHTML = '<option value="">请选择作业</option>'; msg.textContent = ''; msg.className = 'message'; if (!subject || !configData.subjects[subject]) return; const subjectConfig = configData.subjects[subject]; if (!subjectConfig.classes.includes(currentUser.class)) { msg.textContent = '您的班级没有该科目'; msg.className = 'message error'; return; } subjectConfig.homeworks.forEach(h => { hwSelect.add(new Option(h, h)); }); }
        function showAboutPage() { document.getElementById('uploadCard').classList.add('hidden'); document.getElementById('welcomeText').classList.add('hidden'); document.getElementById('uploadForm').classList.add('hidden'); document.getElementById('aboutCard').classList.remove('hidden'); loadChangelog(); }
        function showUploadPage() { document.getElementById('aboutCard').classList.add('hidden'); if (currentUser) { document.getElementById('uploadCard').classList.remove('hidden'); document.getElementById('uploadForm').classList.remove('hidden'); } else { document.getElementById('uploadCard').classList.remove('hidden'); document.getElementById('welcomeText').classList.remove('hidden'); } }
        function showLoginModal() { document.getElementById('loginModal').classList.add('active'); }
        function hideLoginModal() { document.getElementById('loginModal').classList.remove('active'); }
        async function handleLogin(e) { e.preventDefault(); const c = document.getElementById('loginClass').value, id = document.getElementById('loginStudentId').value, n = document.getElementById('loginStudentName').value; try { const r = await fetch('/api/v1/login', { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({class: c, student_id: id, student_name: n}) }); const rs = await r.json(); if (rs.success) { currentUser = rs.data; localStorage.setItem('cums_user', JSON.stringify(currentUser)); updateUserInfo(); hideLoginModal(); showUploadPage(); document.getElementById('loginClass').value = ''; document.getElementById('loginStudentId').value = ''; document.getElementById('loginStudentName').value = ''; } else { alert(rs.message); } } catch (e) { alert('登录失败，请重试'); } }
        function logout() { if (confirm('确定要退出登录吗？')) { currentUser = null; localStorage.removeItem('cums_user'); location.reload(); } }
        function loadSavedUser() { try { const saved = localStorage.getItem('cums_user'); if (saved) { currentUser = JSON.parse(saved); updateUserInfo(); showUploadPage(); } } catch (e) { console.error('加载登录信息失败:', e); } }
        function updateUserInfo() { const u = document.getElementById('userInfo'), t = document.getElementById('classTag'); if (currentUser) { u.innerHTML = '<a class="nav-link" onclick="showAboutPage()">关于</a><span>' + currentUser.class + ' - ' + currentUser.student_id + '号 ' + currentUser.student_name + '</span> <a class="nav-link" onclick="logout()" style="margin-left:12px;color:#ff4d4f;">退出</a>'; t.textContent = currentUser.class; } }
        async function handleUpload(e) { e.preventDefault(); const f = document.getElementById('fileInput'), b = document.getElementById('uploadBtn'), m = document.getElementById('message'); if (!f.files[0]) { m.textContent = '请选择要上传的文件'; m.className = 'message error'; return; } const fd = new FormData(); fd.append('class', currentUser.class); fd.append('student_id', currentUser.student_id); fd.append('student_name', currentUser.student_name); fd.append('subject', document.getElementById('subjectSelect').value); fd.append('homework', document.getElementById('homeworkSelect').value); fd.append('file', f.files[0]); b.disabled = true; b.innerHTML = '<span class="loading"></span>上传中...'; m.className = 'message'; try { const r = await fetch('/api/v1/upload', { method: 'POST', body: fd }); const rs = await r.json(); if (rs.success) { m.textContent = '上传成功：' + rs.filename; m.className = 'message success'; document.getElementById('fileUploadForm').reset(); document.getElementById('fileName').textContent = ''; } else { m.textContent = rs.message; m.className = 'message error'; } } catch (e) { m.textContent = '上传失败，请重试'; m.className = 'message error'; } finally { b.disabled = false; b.textContent = '上传文件'; } }
        document.getElementById('loginModal').addEventListener('click', e => { if (e.target === this) hideLoginModal(); });
        async function init() { await loadConfig(); await loadVersion(); loadSavedUser(); } init();
    </script>
</body>
</html>