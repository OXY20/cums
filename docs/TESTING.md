# CUMS 测试和部署指南

## 📋 快速开始

### 方式一：使用批处理脚本（推荐）

双击运行 `build_and_run.bat` 脚本，它会自动：
1. 检查 Go 环境
2. 编译程序
3. 启动服务器

### 方式二：手动编译和运行

#### 1. 编译程序
打开命令提示符（CMD）或 PowerShell：

```cmd
cd C:\Users\ERSHI\code\cums
go build -o cums.exe .
```

#### 2. 运行程序
```cmd
cums.exe
```

#### 3. 访问系统
在浏览器中打开：`http://localhost:3000`

---

## 🔧 验证编译结果

编译成功后，应该看到：
- ✅ 生成 `cums.exe` 文件（约 2-3 MB）
- ✅ 无编译错误信息

---

## 🧪 功能测试清单

### v1.0.4 新增功能测试

#### 1. 端口自动清理 ⭐ 新功能
- [ ] **测试场景 1**: 启动程序时端口被占用
  - 步骤：运行一个实例，不关闭，直接启动第二个实例
  - 预期：自动终止旧实例，新实例成功启动
  - 输出：`⚠️ 检测到端口 :3000 被占用，正在尝试清理...`

- [ ] **测试场景 2**: 端口未被占用时正常启动
  - 预期：直接启动，无端口清理提示

#### 2. 登录信息本地存储 ⭐ 新功能
- [ ] 刷新页面后保持登录状态
- [ ] 点击"退出"按钮成功退出
- [ ] 退出后显示登录按钮

#### 3. 客户端详细信息记录 ⭐ 新功能
- [ ] 上传文件后查看日志
- [ ] 日志包含：IP 地址和主机名
- [ ] 格式：`[时间] 班级 学号姓名提交作业 IP:xxx 主机名:xxx`

#### 4. 前端优化 ⭐ 新功能
- [ ] 上传表单中**没有**班级选择（登录时已选）
- [ ] 选择科目时检查班级权限
- [ ] 显示"退出"按钮

#### 5. 开发模式支持 ⭐ 新功能
- [ ] `go run main.go` 在当前目录创建 `./cums/`
- [ ] 编译后的 `cums.exe` 在 exe 目录创建 `cums/`

---

### 基础功能测试

#### 6. 启动测试
- [ ] 程序正常启动
- [ ] 显示版本信息（v1.0.4）
- [ ] 显示目录结构
- [ ] 显示配置统计（科目数、班级数、作业总数）
- [ ] 显示已配置科目列表
- [ ] 显示使用说明
- [ ] 监听端口 3000

### 2. 配置测试
程序首次运行会自动创建：
- [ ] `cums/config.json` - 配置文件
- [ ] `cums/static/index.html` - 前端页面
- [ ] `cums/uploads/` - 上传目录
- [ ] `cums/logs/cums.log` - 日志文件

### 3. 登录测试
- [ ] 打开登录弹窗
- [ ] 看到班级下拉列表（一班、二班）
- [ ] 输入学号和姓名
- [ ] 登录成功后显示用户信息

### 4. 上传测试
- [ ] 选择科目（数学、语文、英语）
- [ ] 选择班级
- [ ] 选择作业
- [ ] 选择文件
- [ ] 上传成功显示消息
- [ ] 文件保存到正确位置

### 5. 目录结构验证
```
cums/
├── config.json          ✅ 配置文件
├── static/
│   └── index.html       ✅ 前端页面
├── uploads/
│   ├── 数学/
│   │   ├── 一班/
│   │   │   └── 第一章作业/
│   │   └── 二班/
│   ├── 语文/
│   │   └── 一班/
│   └── 英语/
│       └── 一班/
└── logs/
    └── cums.log        ✅ 日志文件
```

---

## 🐛 常见问题

### 问题 1: 端口被占用
**现象**: 提示端口已被使用

**解决**: 程序会自动尝试下一个端口（3001、3002...）

### 问题 2: 编译失败
**现象**: `go: command not found`

**解决**: 确保已安装 Go 并配置了环境变量

```cmd
go version
```

应该显示：`go version go1.x.x windows/amd64`

### 问题 3: 无法访问页面
**现象**: 浏览器显示"无法访问此网站"

**检查**:
1. 程序是否正在运行
2. 防火墙是否阻止
3. 端口是否正确（查看控制台输出）

---

## 📊 编译输出示例

成功编译后，运行程序应该看到：

```
========================================
  CUMS - 文件上传系统
========================================

目录结构:
  配置: C:\Users\ERSHI\code\cums\cums\config.json
  静态: C:\Users\ERSHI\code\cums\cums\static
  上传: C:\Users\ERSHI\code\cums\cums\uploads

服务器启动: http://0.0.0.0:3000
版本: 1.0.3

按 Ctrl+C 停止服务
```

---

## 🚀 部署到其他机器

### 步骤：
1. 复制 `cums.exe` 到目标机器
2. 创建任意目录，放入 `cums.exe`
3. 运行 `cums.exe`
4. 程序会自动创建所需的目录和配置文件

### 注意事项：
- ✅ 无需安装 Go 环境
- ✅ 单文件部署
- ✅ 自动生成配置
- ✅ 跨平台支持（Windows/Linux/macOS）

---

## 📝 下一步

测试完成后，你可以：
1. ✅ 修改 `cums/config.json` 添加自己的科目和作业
2. ✅ 重启程序加载新配置
3. ✅ 开始使用系统收集学生作业

---

**文档版本**: v1.0.4
**更新日期**: 2026-01-21
**状态**: ✅ 生产就绪

---

## 🆕 v1.0.4 更新内容

### 新增功能
1. ⭐ **端口自动清理**: 启动时自动终止占用端口的进程
2. ⭐ **登录持久化**: 刷新页面保持登录状态
3. ⭐ **退出登录**: 添加退出登录功能
4. ⭐ **客户端详情**: 日志记录客户端 IP 和主机名
5. ⭐ **开发模式**: 支持 `go run` 直接在当前目录运行
6. ⭐ **前端优化**: 移除上传表单的班级选择，添加科目权限检查

### 技术改进
- 跨平台端口清理（Windows: netstat + taskkill, Unix: lsof + kill）
- 智能环境检测（开发模式 vs 生产模式）
- 更友好的启动信息显示
- localStorage 实现登录状态持久化
