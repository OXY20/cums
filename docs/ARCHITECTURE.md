# 系统架构设计文档

## 项目概述

CUMS (Classroom Upload Management System) 是一个专为机房环境设计的文件上传管理系统。

### 设计目标

1. **简单易用**: 学生只需登录即可上传作业
2. **灵活配置**: 支持多班级、多科目、多作业的配置
3. **自动管理**: 文件自动分类存储和重命名
4. **跨平台**: 支持 Windows/Linux/macOS

## 系统架构

### 整体架构

```
┌─────────────────────────────────────────────────────────┐
│                      浏览器客户端                          │
│                    (static/index.html)                   │
└─────────────────────┬───────────────────────────────────┘
                      │ HTTP/HTTPS
                      │
┌─────────────────────▼───────────────────────────────────┐
│                   Go HTTP 服务器                          │
│                     (main.go)                            │
│  ┌──────────────────────────────────────────────────┐   │
│  │  路由层                                            │   │
│  │  - / (首页)                                        │   │
│  │  - /admin (管理员界面)                             │   │
│  │  - /api/v1/login (登录)                           │   │
│  │  - /api/v1/config (配置)                          │   │
│  │  - /api/v1/upload (上传)                          │   │
│  │  - /api/v1/version (版本)                         │   │
│  │  - /api/v1/changelog (更新日志)                   │   │
│  │  - /api/v1/admin/login (管理员登录)               │   │
│  │  - /api/v1/admin/config (管理员配置)              │   │
│  └──────────────────────────────────────────────────┘   │
│  ┌──────────────────────────────────────────────────┐   │
│  │  业务逻辑层                                         │   │
│  │  - 用户登录验证                                     │   │
│  │  - 配置加载和验证                                   │   │
│  │  - 文件上传处理                                     │   │
│  │  - 文件命名和存储                                   │   │
│  │  - 日志记录                                        │   │
│  └──────────────────────────────────────────────────┘   │
└─────────────────────┬───────────────────────────────────┘
                      │
        ┌─────────────┼─────────────┐
        │             │             │
┌───────▼──────┐ ┌───▼────┐ ┌─────▼──────┐
│ config.json  │ │ 上传目录 │ │  日志文件   │
│ (配置文件)    │ │uploads/ │ │ logs/      │
└──────────────┘ └────────┘ └────────────┘
```

## 核心模块设计

### 1. 配置管理模块

**职责**: 加载和管理系统配置

**数据结构**:
```go
type Config struct {
    Version       string                   // 版本号
    ServerAddr    string                   // 服务器地址
    UploadDir     string                   // 上传目录
    AdminEnabled  bool                     // 管理员功能是否启用
    AdminPassword string                   // 管理员密码（明文）
    Subjects      map[string]SubjectConfig // 科目配置
}

type SubjectConfig struct {
    Classes   []string // 该科目对应的班级列表
    Homeworks []string // 该科目的作业列表
}
```

**配置文件格式**:
```json
{
    "version": "2.0.0",
    "server_addr": ":3000",
    "upload_dir": "uploads",
    "admin_enabled": false,
    "admin_password": "admin123",
    "subjects": {
        "数学": {
            "classes": ["一班", "二班"],
            "homeworks": ["第一章作业", "第二章作业"]
        }
    }
}
```

**配置查找顺序**:
1. `{可执行文件目录}/cums/config.json`
2. `./cums/config.json`

### 2. 用户认证模块

**职责**: 验证用户登录信息

**登录流程**:
```
1. 用户输入: 学号 + 姓名
2. 服务器验证: 
   - 检查 --class 参数是否已配置
   - 验证班级是否在配置中存在
   - 验证学号和姓名不为空
3. 返回用户信息:
   {
       "class": "一班",
       "student_id": "01",
       "student_name": "张三"
   }
```

**设计说明**:
- 系统通过 `--class` 参数固定班级,适用于机房固定班级场景
- 前端不需要用户选择班级,简化操作流程
- 学号和姓名仅用于文件命名,不做身份验证

### 3. 文件上传模块

**职责**: 处理文件上传和存储

**上传流程**:
```
1. 接收上传请求
   - 班级、学号、姓名
   - 科目、作业
   - 文件

2. 验证参数
   - 班级是否存在
   - 科目是否存在
   - 班级是否有该科目
   - 作业是否存在

3. 生成文件名
   格式: {作业名}_{学号}_{姓名}_{时间戳}.{扩展名}
   示例: 第一章作业_01_张三_20260119191752.docx

4. 确定存储路径
   默认: uploads/{科目}/{班级}/{作业名}/
   示例: uploads/数学/一班/第一章作业/

5. 保存文件

6. 记录日志
   控制台: [2026-01-19 19:17:52] 一班 01号张三提交第一章作业作业
   文件: cums/logs/cums.log
```

**文件命名规则**:
- 使用时间戳确保文件名唯一
- 保留原文件扩展名
- 包含学生信息便于识别

**目录结构**:
```
uploads/
├── 数学/
│   ├── 一班/
│   │   ├── 第一章作业/
│   │   │   ├── 第一章作业_01_张三_20260119191752.docx
│   │   │   └── 第一章作业_02_李四_20260119192030.pdf
│   │   └── 第二章作业/
│   └── 二班/
├── 语文/
└── 英语/
```

### 4. 日志记录模块

**职责**: 记录系统运行日志和上传记录

**日志类型**:
1. **控制台日志**: 实时显示上传记录
2. **文件日志**: 持久化保存到 `cums/logs/cums.log`

**日志格式**:
```
[2026-01-19 19:17:52] 一班 01号张三提交第一章作业作业
```

## 数据流程

### 登录流程

```
用户 -> 输入学号姓名 -> POST /api/v1/login
                              |
                              v
                        验证班级配置
                              |
                    ┌─────────┴─────────┐
                    │                   │
                  成功                 失败
                    │                   │
                    v                   v
            返回用户信息          返回错误信息
                    │
                    v
            前端保存用户状态
                    │
                    v
            加载科目和作业列表
```

### 上传流程

```
用户 -> 选择科目/作业/文件 -> POST /api/v1/upload
                                    |
                                    v
                              验证参数完整性
                                    |
                          ┌─────────┴─────────┐
                          │                   │
                        成功                 失败
                          │                   │
                          v                   v
                    生成文件名          返回错误信息
                          │
                          v
                    创建存储目录
                          │
                          v
                      保存文件
                          │
                          v
                      记录日志
                          │
                          v
                    返回成功信息
```

## 技术选型

### 后端

- **语言**: Go 1.25.3
- **标准库**: 
  - `net/http`: HTTP 服务器
  - `encoding/json`: JSON 处理
  - `os`: 文件操作
  - `path/filepath`: 路径处理

**选择理由**:
- Go 编译为单一可执行文件,部署简单
- 标准库功能完善,无需外部依赖
- 跨平台编译支持好
- 性能优秀,资源占用低

### 前端

- **技术**: 原生 HTML + CSS + JavaScript
- **无框架依赖**

**选择理由**:
- 单页面应用,无需复杂框架
- 加载速度快
- 兼容性好
- 易于维护

### 存储

- **配置**: JSON 文件
- **文件**: 本地文件系统
- **日志**: 文本文件

**选择理由**:
- 无需数据库,降低部署复杂度
- 配置文件易于编辑
- 文件直接存储,便于管理

## 部署架构

### 单机部署

```
┌─────────────────────────────────────┐
│         机房教师机/服务器              │
│                                     │
│  ┌──────────────────────────────┐  │
│  │      CUMS 可执行文件           │  │
│  │      监听 0.0.0.0:3000        │  │
│  └──────────────────────────────┘  │
│                                     │
│  ┌──────────────────────────────┐  │
│  │      cums/                    │  │
│  │      ├── config.json          │  │
│  │      ├── static/              │  │
│  │      ├── uploads/             │  │
│  │      └── logs/                │  │
│  └──────────────────────────────┘  │
└─────────────────────────────────────┘
                │
                │ 局域网
                │
    ┌───────────┼───────────┐
    │           │           │
┌───▼───┐  ┌───▼───┐  ┌───▼───┐
│学生机1 │  │学生机2 │  │学生机N │
└───────┘  └───────┘  └───────┘
```

### 使用场景

1. **机房固定班级**: 使用 `--class` 参数启动
   ```bash
   cums.exe --class 一班
   ```

2. **多班级共用**: 不使用 `--class` 参数,让学生选择班级
   ```bash
   cums.exe
   ```

## 安全考虑

### 当前实现

1. **学生无身份验证**: 仅记录学号姓名,不验证身份
2. **管理员密码验证**: 管理员功能需密码登录
3. **管理员功能默认关闭**: `admin_enabled` 默认为 `false`
4. **无文件类型限制**: 接受任意文件类型
5. **无文件大小限制**: 由系统和网络决定

### 管理员安全设计

1. **功能开关**: 管理员功能默认关闭，需手动在配置文件中启用
2. **密码验证**: 访问管理界面需输入密码
3. **会话令牌**: 登录成功后生成临时令牌，用于后续请求验证
4. **明文存储**: 密码以明文存储在配置文件中（适用于内网环境）

### 适用场景

- 内网环境
- 机房局域网
- 信任的用户群体

### 未来改进方向

1. 添加文件类型白名单
2. 添加文件大小限制
3. 添加用户身份验证
4. 添加上传频率限制
5. 管理员密码加密存储

## 扩展性设计

### 配置扩展

当前配置支持:
- 多科目
- 多班级
- 多作业

未来可扩展:
- 自定义存储路径
- 文件类型限制
- 上传时间限制

### 功能扩展

当前功能:
- 文件上传
- 日志记录
- 管理员界面（科目/班级/作业管理）

未来可扩展:
- 文件下载
- 文件预览
- 统计报表
- 批量下载

### TODO: 作业附件功能（计划中）

以下功能已在规划中，暂未实装：

1. **作业模板下载**
   - 每个作业可提供模板文件供学生下载
   - 学生下载模板 → 完成作业 → 上传提交

2. **作业说明文字**
   - 每个作业可添加说明文字
   - 说明文字在上传界面展示

3. **作业说明图片**
   - 每个作业可添加说明图片
   - 图片在上传界面展示

**预期配置结构**（未实装）：
```json
{
    "subjects": {
        "数学": {
            "classes": ["一班"],
            "homeworks": [
                {
                    "name": "第一章作业",
                    "description": "请完成课本P20-P25的习题",
                    "template": "templates/math_ch1.docx",
                    "images": ["images/math_ch1_hint.png"]
                }
            ]
        }
    }
}
```

## 性能考虑

### 并发处理

- Go 的 `net/http` 自动处理并发请求
- 每个请求在独立的 goroutine 中处理

### 文件存储

- 直接写入文件系统
- 使用时间戳避免文件名冲突
- 按科目/班级/作业分目录存储

### 资源占用

- 内存占用: < 50MB
- CPU 占用: 低 (仅在上传时处理)
- 磁盘占用: 取决于上传文件

## 错误处理

### 配置错误

- 配置文件不存在: 自动创建默认配置
- 配置格式错误: 程序退出并提示

### 运行时错误

- 端口被占用: 自动尝试下一个端口
- 目录创建失败: 返回错误信息
- 文件写入失败: 返回错误信息

### 用户错误

- 参数缺失: 返回明确的错误提示
- 班级不存在: 列出可用班级
- 科目不存在: 返回错误提示

## 维护性

### 代码组织

- 单文件实现 (`main.go`)
- 清晰的函数划分
- 统一的错误处理

### 日志记录

- 控制台输出: 便于实时监控
- 文件日志: 便于事后分析

### 配置管理

- JSON 格式: 易于编辑
- 注释说明: 配置文档完善

## 总结

CUMS 采用简单实用的架构设计,专注于解决机房文件上传的核心需求。通过 Go 语言的单文件部署特性和标准库的强大功能,实现了一个轻量级、高性能、易维护的文件上传系统。
