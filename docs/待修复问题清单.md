# CUMS 项目待修复问题清单

> 创建日期: 2026-01-25
> 状态: 待修复
> 优先级说明: P0(紧急) > P1(重要) > P2(一般) > P3(低)

---

## 一、编译/构建问题

### 1. go.mod 版本号错误
- **优先级**: P0
- **文件**: `go.mod`
- **问题描述**: `go 1.25` 是不存在的 Go 版本，当前最新稳定版为 1.22
- **影响**: 可能导致编译警告或兼容性问题
- **修复方案**: 将版本改为 `go 1.21` 或 `go 1.22`
- **状态**: [x] 无需修复
- **反馈**:
  - 用户意见: 用户使用 Go 1.25.0 版本，当前配置正确
  - 追加建议: 无需修改，保持现状
  - 实施状态: [x] 无需实施

---

### 2. embed.go 引用的文件不存在
- **优先级**: P0
- **文件**: `embed.go`
- **问题描述**: 嵌入的 `CHANGELOG.md` 文件不存在
- **影响**: 编译失败
- **修复方案**:
  - 方案A: 创建 `CHANGELOG.md` 文件
  - 方案B: 删除 `embed.go` 中的嵌入声明
- **状态**: [x] 已修复
- **反馈**:
  - 用户意见: 选择方案A，保留并完善 changelog 功能
  - 追加建议: CHANGELOG.md 已存在，实现了 /api/v1/changelog API 接口使 embed 变量真正被使用
  - 实施状态: [x] 已实施

---

## 二、后端代码问题

### 3. jsonResponse 函数未处理错误
- **优先级**: P1
- **文件**: `main.go` 第 493-496 行
- **问题描述**: `json.NewEncoder(w).Encode(data)` 的返回错误被忽略
- **影响**: 编码失败时无法感知，可能导致响应异常
- **修复方案**:
```go
func jsonResponse(w http.ResponseWriter, data interface{}) {
    w.Header().Set("Content-Type", "application/json; charset=utf-8")
    if err := json.NewEncoder(w).Encode(data); err != nil {
        log.Printf("JSON 编码失败: %v", err)
    }
}
```
- **状态**: [x] 已修复
- **反馈**:
  - 用户意见: 批量修复
  - 追加建议: 已添加错误日志记录，同时新增 jsonResponseWithStatus 函数支持状态码
  - 实施状态: [x] 已实施

---

### 4. configHandler 缺少请求方法验证
- **优先级**: P1
- **文件**: `main.go` 第 209-216 行
- **问题描述**: 未限制 HTTP 方法，任何方法都能访问
- **影响**: 不符合 RESTful 规范，可能导致意外行为
- **修复方案**:
```go
func configHandler(w http.ResponseWriter, r *http.Request) {
    if r.Method != http.MethodGet {
        w.WriteHeader(http.StatusMethodNotAllowed)
        jsonResponse(w, APIResponse{Success: false, Message: "请求方法错误"})
        return
    }
    // ... 原有逻辑
}
```
- **状态**: [x] 已修复
- **反馈**:
  - 用户意见: 批量修复
  - 追加建议: 已添加 GET 方法验证，错误时返回 405 状态码
  - 实施状态: [x] 已实施

---

### 5. HTTP 响应未设置正确状态码
- **优先级**: P1
- **文件**: `main.go` 多处 Handler 函数
- **问题描述**: 所有错误响应都返回 200 状态码，仅通过 JSON 中的 `success` 字段区分
- **影响**: 不符合 RESTful API 规范，前端错误处理不便
- **涉及函数**:
  - `loginHandler`
  - `uploadHandler`
  - `adminLoginHandler`
  - `adminConfigHandler`
- **修复方案**: 在返回错误响应前调用 `w.WriteHeader(http.StatusXXX)`
- **状态**: [x] 已修复
- **反馈**:
  - 用户意见: 批量修复
  - 追加建议: 已为所有 Handler 添加正确的 HTTP 状态码（400/401/403/405/500）
  - 实施状态: [x] 已实施

---

### 6. 管理员令牌生成不安全
- **优先级**: P1
- **文件**: `main.go` 第 454-456 行
- **问题描述**: 令牌基于时间戳生成，格式为 `admin_{纳秒}_{秒}`，可被预测
- **影响**: 存在令牌伪造风险
- **修复方案**:
```go
import "crypto/rand"

func generateAdminToken() string {
    b := make([]byte, 32)
    rand.Read(b)
    return fmt.Sprintf("admin_%x", b)
}
```
- **状态**: [x] 已修复
- **反馈**:
  - 用户意见: 批量修复
  - 追加建议: 已使用 crypto/rand 生成 32 字节随机令牌，并添加降级处理
  - 实施状态: [x] 已实施

---

### 7. adminTokens 没有定期清理机制
- **优先级**: P2
- **文件**: `main.go` 第 82 行
- **问题描述**: 过期令牌只在验证时删除，长期运行会积累大量过期条目
- **影响**: 内存泄漏风险
- **修复方案**: 添加定时清理 goroutine
```go
func init() {
    go func() {
        ticker := time.NewTicker(1 * time.Hour)
        for range ticker.C {
            now := time.Now()
            for token, expiry := range adminTokens {
                if now.After(expiry) {
                    delete(adminTokens, token)
                }
            }
        }
    }()
}
```
- **状态**: [x] 已修复
- **反馈**:
  - 用户意见: 批量修复
  - 追加建议: 已添加 init() 函数启动清理协程，每小时清理一次过期令牌
  - 实施状态: [x] 已实施

---

## 三、安全问题

### 8. 文件名存在路径遍历风险
- **优先级**: P0
- **文件**: `main.go` 第 288 行
- **问题描述**: `studentName`、`homework`、`studentID` 等用户输入直接用于构建文件名和路径，可能包含 `../` 等危险字符
- **影响**: 路径遍历攻击，可能覆盖系统文件
- **修复方案**:
```go
// 添加安全过滤函数
func sanitizeFilename(name string) string {
    // 移除路径分隔符和其他危险字符
    name = strings.ReplaceAll(name, "/", "_")
    name = strings.ReplaceAll(name, "\\", "_")
    name = strings.ReplaceAll(name, "..", "_")
    name = strings.ReplaceAll(name, ":", "_")
    return strings.TrimSpace(name)
}

// 在 uploadHandler 中使用
filename := fmt.Sprintf("%s_%s_%s_%s%s",
    sanitizeFilename(homework),
    sanitizeFilename(studentID),
    sanitizeFilename(studentName),
    timestamp, ext)
```
- **状态**: [x] 已修复
- **反馈**:
  - 用户意见: 采用严格方案，只允许字母、数字、下划线、连字符和中文字符
  - 追加建议: 已实现 sanitizeFilename() 函数，对文件名和存储路径都进行过滤，过滤后为空时返回 "unnamed" 默认值
  - 实施状态: [x] 已实施

---

### 9. 无文件类型白名单验证
- **优先级**: P2
- **文件**: `main.go` `uploadHandler` 函数
- **问题描述**: 接受任意文件类型上传，包括可执行文件
- **影响**: 可能上传恶意文件
- **修复方案**:
```go
var allowedExtensions = map[string]bool{
    ".doc": true, ".docx": true, ".pdf": true,
    ".xls": true, ".xlsx": true, ".ppt": true, ".pptx": true,
    ".txt": true, ".jpg": true, ".jpeg": true, ".png": true,
    ".zip": true, ".rar": true, ".7z": true,
}

// 在 uploadHandler 中验证
ext := strings.ToLower(filepath.Ext(header.Filename))
if !allowedExtensions[ext] {
    jsonResponse(w, UploadResponse{Success: false, Message: "不支持的文件类型"})
    return
}
```
- **状态**: [x] 已修复
- **反馈**:
  - 用户意见: 批量修复
  - 追加建议: 已添加文件类型白名单，支持文档、图片、压缩包、代码文件等常用格式
  - 实施状态: [x] 已实施

---

## 四、前端代码问题

### 10. loadConfig 使用错误的 HTTP 方法
- **优先级**: P1
- **文件**: `build/static/index.html` 第 555-557 行
- **问题描述**: 使用 POST 请求获取配置数据，应使用 GET
- **影响**: 语义不正确，与后端预期不符
- **修复方案**:
```javascript
const res = await fetch('/api/v1/config', {
    method: 'GET'
});
```
- **状态**: [x] 已修复
- **反馈**:
  - 用户意见: 批量修复
  - 追加建议: 已将 POST 改为 GET，移除不必要的 headers
  - 实施状态: [x] 已实施

---

### 11. admin.html 存在 XSS 风险
- **优先级**: P1
- **文件**: `build/static/admin.html` 第 914-957 行
- **问题描述**: 使用 `innerHTML` 直接插入用户数据（班级名、科目名、作业名）
- **影响**: 如果数据包含 `<script>` 标签，会造成 XSS 攻击
- **修复方案**: 添加 HTML 转义函数
```javascript
function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}

// 使用时
${escapeHtml(c)}
${escapeHtml(name)}
```
- **状态**: [x] 已修复
- **反馈**:
  - 用户意见: 批量修复
  - 追加建议: 已添加 escapeHtml 函数，对所有动态插入的科目名、班级名、作业名进行转义
  - 实施状态: [x] 已实施

---

### 12. index.html 存在 XSS 风险
- **优先级**: P1
- **文件**: `build/static/index.html` 第 744-747 行
- **问题描述**: 用户信息（班级、学号、姓名）直接插入 `innerHTML`
- **影响**: XSS 攻击风险
- **修复方案**: 同上，添加 HTML 转义函数
- **状态**: [x] 已修复
- **反馈**:
  - 用户意见: 批量修复
  - 追加建议: 已添加 escapeHtml 函数，对用户班级、学号、姓名进行转义
  - 实施状态: [x] 已实施

---

## 五、架构/结构问题

### 13. 静态文件目录结构不统一
- **优先级**: P3
- **文件**: 项目目录结构
- **问题描述**: `build/static/` 存放源文件，运行时需要 `static/` 目录，两者分离容易混淆
- **影响**: 开发和部署流程复杂，容易出错
- **修复方案**:
  - 方案A: 使用 `go:embed` 将静态文件嵌入到可执行文件中
  - 方案B: 统一使用一个目录，添加构建脚本自动复制
- **状态**: [ ] 待修复
- **反馈**:
  - 用户意见:
  - 追加建议:
  - 实施状态: [ ] 待实施

---

### 14. embed.go 中的 changelog 变量未使用
- **优先级**: P3
- **文件**: `embed.go`
- **问题描述**: 声明了 `var changelog embed.FS` 但代码中从未使用
- **影响**: 无用代码，增加维护成本
- **修复方案**:
  - 方案A: 实现 `/api/v1/changelog` API 接口
  - 方案B: 删除 `embed.go` 文件
- **状态**: [x] 已修复
- **反馈**:
  - 用户意见: 选择方案A
  - 追加建议: 已在问题2中实现 /api/v1/changelog API，changelog 变量现已被使用
  - 实施状态: [x] 已实施（与问题2合并）

---

### 15. 缺少中间件封装
- **优先级**: P3
- **文件**: `main.go`
- **问题描述**: 无统一的请求日志记录、CORS 支持、panic 恢复等中间件
- **影响**: 调试困难，跨域请求可能失败
- **修复方案**: 添加中间件函数
```go
func loggingMiddleware(next http.HandlerFunc) http.HandlerFunc {
    return func(w http.ResponseWriter, r *http.Request) {
        start := time.Now()
        next(w, r)
        log.Printf("%s %s %v", r.Method, r.URL.Path, time.Since(start))
    }
}

func recoveryMiddleware(next http.HandlerFunc) http.HandlerFunc {
    return func(w http.ResponseWriter, r *http.Request) {
        defer func() {
            if err := recover(); err != nil {
                log.Printf("Panic: %v", err)
                http.Error(w, "Internal Server Error", http.StatusInternalServerError)
            }
        }()
        next(w, r)
    }
}
```
- **状态**: [ ] 待修复
- **反馈**:
  - 用户意见:
  - 追加建议:
  - 实施状态: [ ] 待实施

---

## 六、修复进度统计

| 优先级 | 总数 | 已完成 | 待修复 |
|--------|------|--------|--------|
| P0     | 3    | 0      | 3      |
| P1     | 7    | 0      | 7      |
| P2     | 2    | 0      | 2      |
| P3     | 3    | 0      | 3      |
| **总计** | **15** | **0** | **15** |

---

## 七、修复顺序建议

1. **第一阶段 (P0)**: 先解决编译问题和安全漏洞
   - 问题 1: go.mod 版本
   - 问题 2: CHANGELOG.md 缺失
   - 问题 8: 路径遍历风险

2. **第二阶段 (P1)**: 修复代码规范和 XSS 问题
   - 问题 3-6: 后端代码规范
   - 问题 10-12: 前端问题

3. **第三阶段 (P2/P3)**: 优化和重构
   - 问题 7, 9: 安全增强
   - 问题 13-15: 架构优化

---

## 八、审阅意见汇总

> 此处汇总用户对整体问题清单的审阅意见

- **整体审阅意见**: [待填写]
- **优先级调整建议**: [待填写]
- **其他补充**: [待填写]

---

*文档维护者: Claude Code*
*最后更新: 2026-01-25*
