# CUMS 重构设计文档

> 版本: 2.0.0  
> 日期: 2026-01-22  
> 状态: 设计阶段

## 一、项目定位

**CUMS** (Classroom Upload Management System) 是一个专为**局域网机房**环境设计的**简单作业上传系统**。

### 核心目标

1. **简单** - 代码简洁，易于理解和维护
2. **实用** - 满足机房作业收集的核心需求
3. **可靠** - 稳定运行，文件不丢失

### 使用场景

- 学校机房
- 局域网环境
- 教师收集学生作业
- 无需互联网连接

## 二、功能需求

### 核心功能

| 功能 | 描述 | 优先级 |
|------|------|--------|
| 学生登录 | 选择班级、输入学号姓名 | P0 |
| 作业上传 | 选择科目和作业，上传文件 | P0 |
| 文件存储 | 按科目/班级/作业自动分类 | P0 |
| 配置管理 | JSON 配置科目、班级、作业 | P0 |

### 非功能需求

| 需求 | 描述 |
|------|------|
| 单文件部署 | 编译为单一可执行文件 |
| 自动初始化 | 首次运行自动创建配置和目录 |
| 局域网访问 | 学生机可通过 IP 访问 |
| 上传日志 | 记录谁在什么时间上传了什么 |

### 不需要的功能

- ❌ 用户认证/密码
- ❌ 文件下载/预览
- ❌ 数据库
- ❌ 用户管理后台
- ❌ 复杂的权限控制

## 三、技术架构

### 整体架构

```
┌─────────────────────────────────────────┐
│           浏览器 (学生机)                  │
│         static/index.html               │
└────────────────┬────────────────────────┘
                 │ HTTP
                 │
┌────────────────▼────────────────────────┐
│              Go 服务器                    │
│              main.go                     │
│                                         │
│  ┌────────────────────────────────────┐ │
│  │ API 路由                            │ │
│  │ - POST /api/v1/login   登录         │ │
│  │ - POST /api/v1/config  获取配置     │ │
│  │ - POST /api/v1/upload  上传文件     │ │
│  │ - GET  /api/v1/version 版本信息     │ │
│  └────────────────────────────────────┘ │
└────────────────┬────────────────────────┘
                 │
    ┌────────────┼────────────┐
    │            │            │
┌───▼────┐  ┌───▼────┐  ┌───▼────┐
│config  │  │uploads │  │ logs   │
│.json   │  │/       │  │/       │
└────────┘  └────────┘  └────────┘
```

### 目录结构

```
程序目录/
├── cums.exe              # 可执行文件
└── cums/                 # 运行时数据目录
    ├── config.json       # 配置文件
    ├── static/
    │   └── index.html    # 前端页面
    ├── uploads/          # 上传文件
    │   └── {科目}/{班级}/{作业}/
    └── logs/
        └── cums.log      # 上传日志
```

## 四、配置设计

### 配置文件 (config.json)

```json
{
    "version": "2.0.0",
    "server_addr": ":3000",
    "subjects": {
        "数学": {
            "classes": ["一班", "二班"],
            "homeworks": ["第一章作业", "第二章作业"]
        },
        "语文": {
            "classes": ["一班"],
            "homeworks": ["作文", "阅读理解"]
        }
    }
}
```

### 配置说明

| 字段 | 类型 | 说明 |
|------|------|------|
| version | string | 版本号 |
| server_addr | string | 服务器端口，如 ":3000" |
| subjects | object | 科目配置 |
| subjects.{科目}.classes | array | 该科目对应的班级列表 |
| subjects.{科目}.homeworks | array | 该科目的作业列表 |

## 五、API 设计

### 1. 登录接口

```
POST /api/v1/login
Content-Type: application/json

请求:
{
    "class": "一班",
    "student_id": "01",
    "student_name": "张三"
}

响应:
{
    "success": true,
    "message": "登录成功",
    "data": {
        "class": "一班",
        "student_id": "01",
        "student_name": "张三"
    }
}
```

### 2. 获取配置

```
POST /api/v1/config
Content-Type: application/json

响应:
{
    "success": true,
    "data": {
        "subjects": { ... }
    }
}
```

### 3. 文件上传

```
POST /api/v1/upload
Content-Type: multipart/form-data

参数:
- class: 班级
- student_id: 学号
- student_name: 姓名
- subject: 科目
- homework: 作业名称
- file: 文件

响应:
{
    "success": true,
    "message": "上传成功",
    "filename": "第一章作业_01_张三_20260122100000.docx"
}
```

### 4. 版本信息

```
GET /api/v1/version

响应:
{
    "success": true,
    "version": "2.0.0"
}
```

## 六、前端设计

### 页面结构

```
┌─────────────────────────────────────────┐
│  CUMS - 文件上传系统         [关于] [登录] │
├─────────────────────────────────────────┤
│                                         │
│  ┌───────────────────────────────────┐  │
│  │                                   │  │
│  │        请先登录                    │  │
│  │                                   │  │
│  │         [登录]                    │  │
│  │                                   │  │
│  └───────────────────────────────────┘  │
│                                         │
├─────────────────────────────────────────┤
│              关于 · v2.0.0              │
└─────────────────────────────────────────┘
```

### 登录后

```
┌─────────────────────────────────────────┐
│  CUMS - 文件上传系统     一班-01号张三    │
├─────────────────────────────────────────┤
│                                         │
│  ┌───────────────────────────────────┐  │
│  │  [一班]                           │  │
│  │                                   │  │
│  │  科目:  [请选择科目      ▼]       │  │
│  │                                   │  │
│  │  作业:  [请选择作业      ▼]       │  │
│  │                                   │  │
│  │  文件:  [选择文件...]             │  │
│  │                                   │  │
│  │         [上传文件]                │  │
│  │                                   │  │
│  └───────────────────────────────────┘  │
│                                         │
└─────────────────────────────────────────┘
```

### 用户流程

1. 打开页面 → 显示"请先登录"
2. 点击登录 → 弹出登录框
3. 选择班级、输入学号姓名 → 登录
4. 选择科目 → 选择作业 → 选择文件
5. 点击上传 → 显示结果

## 七、文件命名规则

### 格式

```
{作业名}_{学号}_{姓名}_{时间戳}.{扩展名}
```

### 示例

```
第一章作业_01_张三_20260122100000.docx
```

### 存储路径

```
uploads/{科目}/{班级}/{作业}/{文件名}
```

### 示例

```
uploads/数学/一班/第一章作业/第一章作业_01_张三_20260122100000.docx
```

## 八、日志设计

### 日志格式

```
[2026-01-22 10:00:00] 一班 01号张三 提交 数学-第一章作业 IP:192.168.1.100
```

### 日志位置

```
cums/logs/cums.log
```

## 九、代码结构 (重构后)

### main.go

```go
package main

// ==================== 数据结构 ====================

type Config struct { ... }
type SubjectConfig struct { ... }
type LoginRequest struct { ... }
type LoginResponse struct { ... }
// ...

// ==================== 全局变量 ====================

var config Config
var version = "2.0.0"

// ==================== 配置管理 ====================

func loadConfig() error { ... }
func saveDefaultConfig() error { ... }

// ==================== HTTP 处理器 ====================

func loginHandler(w, r) { ... }
func configHandler(w, r) { ... }
func uploadHandler(w, r) { ... }
func versionHandler(w, r) { ... }

// ==================== 工具函数 ====================

func jsonResponse(w, data) { ... }
func getLocalIP() string { ... }
func writeLog(message) { ... }

// ==================== 主函数 ====================

func main() { ... }
```

### 代码行数目标

| 模块 | 目标行数 |
|------|----------|
| main.go | < 500 行 |
| index.html | < 400 行 |

## 十、重构检查清单

### 后端重构

- [ ] 移除不必要的调试输出
- [ ] 简化配置加载逻辑
- [ ] 简化文件路径处理
- [ ] 移除端口占用检测（改为简单报错）
- [ ] 简化日志记录
- [ ] 统一错误处理

### 前端重构

- [ ] 简化 CSS（移除不必要的样式）
- [ ] 简化 JavaScript 逻辑
- [ ] 添加清晰的注释
- [ ] 修复登录状态管理问题
- [ ] 统一命名规范

### 文档更新

- [ ] 更新 README.md
- [ ] 更新 API.md
- [ ] 更新 CONFIG.md
- [ ] 清理过时文档

## 十一、测试要点

### 功能测试

1. 首次启动自动创建配置
2. 登录功能正常
3. 科目/作业选择联动正确
4. 文件上传成功
5. 文件正确存储到对应目录
6. 日志正确记录

### 兼容性测试

1. Windows 10/11
2. Chrome/Edge/Firefox
3. 局域网访问

---

**文档版本**: v1.0  
**创建日期**: 2026-01-22
