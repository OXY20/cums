on:
  push:
    tags:
      - 'v*'  # 推送 v2.0.0 这种 tag 时触发

# 设置必要的权限
permissions:
  contents: write

jobs:
  build:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        include:
          - goos: windows
            goarch: amd64
            suffix: .exe
            platform: windows
          - goos: linux
            goarch: amd64
            suffix: ''
            platform: linux
          - goos: darwin
            goarch: amd64
            suffix: ''
            platform: mac
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-go@v5
        with:
          go-version: '1.25'
      - name: 构建并打包
        run: |
          # 设置版本号和日期
          VERSION=${GITHUB_REF#refs/tags/}
          DATE=$(date +%Y%m%d)

          # 编译（使用矩阵变量）
          GOOS=${{ matrix.goos }} GOARCH=${{ matrix.goarch }} go build -o build/cums${{ matrix.suffix }}

          # 创建打包目录
          mkdir -p release

          # 复制文件
          cp build/cums${{ matrix.suffix }} release/
          cp -r static release/
          cp config.json release/

          # 打包成 zip，文件名格式：cums_v2.0.0_20260122_windows.zip
          cd release
          zip -r ../cums_${VERSION}_${DATE}_${{ matrix.platform }}.zip *
      - name: 上传到 Release
        uses: softprops/action-gh-release@v1
        with:
          files: cums_*.zip
