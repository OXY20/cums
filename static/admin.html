<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CUMS - ç®¡ç†å‘˜æ§åˆ¶å°</title>
    <style>
        /* ========== åŸºç¡€æ ·å¼ ========== */
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        body {
            font-family: 'Segoe UI', 'PingFang SC', 'Microsoft YaHei', sans-serif;
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 50%, #0f3460 100%);
            min-height: 100vh;
            color: #e8e8e8;
        }

        /* ========== å¤´éƒ¨ ========== */
        .header {
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(10px);
            padding: 16px 24px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .header h1 {
            font-size: 18px;
            font-weight: 500;
            color: #fff;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .header h1 .badge {
            background: linear-gradient(135deg, #e94560, #ff6b6b);
            padding: 2px 8px;
            border-radius: 4px;
            font-size: 10px;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 16px;
            font-size: 14px;
            color: rgba(255, 255, 255, 0.7);
        }

        /* ========== æŒ‰é’® ========== */
        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 500;
        }

        .btn-primary {
            background: linear-gradient(135deg, #e94560, #ff6b6b);
            color: #fff;
            box-shadow: 0 4px 15px rgba(233, 69, 96, 0.3);
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(233, 69, 96, 0.4);
        }

        .btn-secondary {
            background: rgba(255, 255, 255, 0.1);
            color: #fff;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .btn-secondary:hover {
            background: rgba(255, 255, 255, 0.15);
        }

        .btn-danger {
            background: transparent;
            color: #ff6b6b;
            border: 1px solid #ff6b6b;
        }

        .btn-danger:hover {
            background: rgba(255, 107, 107, 0.1);
        }

        .btn-success {
            background: linear-gradient(135deg, #00d9a5, #00b894);
            color: #fff;
            box-shadow: 0 4px 15px rgba(0, 217, 165, 0.3);
        }

        .btn-success:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0, 217, 165, 0.4);
        }

        .btn-small {
            padding: 6px 12px;
            font-size: 12px;
        }

        .btn-icon {
            width: 32px;
            height: 32px;
            padding: 0;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            border-radius: 6px;
            font-size: 16px;
        }

        /* ========== ä¸»å†…å®¹ ========== */
        .main {
            max-width: 900px;
            margin: 40px auto;
            padding: 0 20px;
        }

        .card {
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(10px);
            border-radius: 16px;
            padding: 32px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
        }

        .card-title {
            font-size: 20px;
            font-weight: 600;
            margin-bottom: 24px;
            color: #fff;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        /* ========== ç™»å½•é¡µ ========== */
        .login-container {
            max-width: 400px;
            margin: 100px auto;
        }

        .login-card {
            text-align: center;
        }

        .login-logo {
            width: 80px;
            height: 80px;
            background: linear-gradient(135deg, #e94560, #ff6b6b);
            border-radius: 20px;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            font-size: 36px;
            margin-bottom: 20px;
            box-shadow: 0 8px 24px rgba(233, 69, 96, 0.4);
        }

        .login-title {
            font-size: 24px;
            margin-bottom: 8px;
        }

        .login-subtitle {
            color: rgba(255, 255, 255, 0.5);
            margin-bottom: 32px;
            font-size: 14px;
        }

        /* ========== è¡¨å• ========== */
        .form-group {
            margin-bottom: 20px;
            text-align: left;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-size: 14px;
            color: rgba(255, 255, 255, 0.7);
        }

        .form-group input,
        .form-group select {
            width: 100%;
            padding: 12px 16px;
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 10px;
            font-size: 14px;
            background: rgba(255, 255, 255, 0.05);
            color: #fff;
            transition: all 0.3s ease;
        }

        .form-group input:focus,
        .form-group select:focus {
            outline: none;
            border-color: #e94560;
            box-shadow: 0 0 0 3px rgba(233, 69, 96, 0.2);
        }

        .form-group input::placeholder {
            color: rgba(255, 255, 255, 0.3);
        }

        .submit-btn {
            width: 100%;
            padding: 14px;
            margin-top: 8px;
        }

        /* ========== æ¶ˆæ¯æç¤º ========== */
        .message {
            padding: 12px 16px;
            border-radius: 10px;
            margin-bottom: 20px;
            font-size: 14px;
            display: none;
        }

        .message.success {
            display: block;
            background: rgba(0, 217, 165, 0.15);
            border: 1px solid rgba(0, 217, 165, 0.3);
            color: #00d9a5;
        }

        .message.error {
            display: block;
            background: rgba(255, 107, 107, 0.15);
            border: 1px solid rgba(255, 107, 107, 0.3);
            color: #ff6b6b;
        }

        /* ========== ç§‘ç›®åˆ—è¡¨ ========== */
        .subject-list {
            display: flex;
            flex-direction: column;
            gap: 16px;
        }

        .subject-item {
            background: rgba(255, 255, 255, 0.03);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            padding: 20px;
            transition: all 0.3s ease;
        }

        .subject-item:hover {
            border-color: rgba(233, 69, 96, 0.3);
            background: rgba(255, 255, 255, 0.05);
        }

        .subject-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
        }

        .subject-name {
            font-size: 18px;
            font-weight: 600;
            color: #fff;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .subject-name .icon {
            width: 32px;
            height: 32px;
            background: linear-gradient(135deg, #667eea, #764ba2);
            border-radius: 8px;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
        }

        .subject-actions {
            display: flex;
            gap: 8px;
        }

        .subject-content {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 16px;
        }

        .content-section {
            background: rgba(0, 0, 0, 0.2);
            border-radius: 10px;
            padding: 16px;
        }

        .content-section h4 {
            font-size: 12px;
            text-transform: uppercase;
            letter-spacing: 1px;
            color: rgba(255, 255, 255, 0.5);
            margin-bottom: 12px;
        }

        .tag-list {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
        }

        .tag {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 6px 12px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 20px;
            font-size: 13px;
            color: rgba(255, 255, 255, 0.8);
        }

        .tag .remove-btn {
            width: 16px;
            height: 16px;
            border-radius: 50%;
            background: rgba(255, 107, 107, 0.3);
            border: none;
            color: #ff6b6b;
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            transition: all 0.2s;
        }

        .tag .remove-btn:hover {
            background: #ff6b6b;
            color: #fff;
        }

        .add-tag-btn {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            padding: 6px 12px;
            background: transparent;
            border: 1px dashed rgba(255, 255, 255, 0.3);
            border-radius: 20px;
            font-size: 13px;
            color: rgba(255, 255, 255, 0.5);
            cursor: pointer;
            transition: all 0.2s;
        }

        .add-tag-btn:hover {
            border-color: #e94560;
            color: #e94560;
        }

        /* ========== æ·»åŠ ç§‘ç›®åŒºåŸŸ ========== */
        .add-subject-area {
            margin-top: 24px;
            padding-top: 24px;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
        }

        .add-form {
            display: flex;
            gap: 12px;
            align-items: flex-end;
        }

        .add-form .form-group {
            flex: 1;
            margin-bottom: 0;
        }

        /* ========== æ“ä½œæ  ========== */
        .action-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 24px;
            padding-bottom: 16px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .action-bar-left {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .action-bar-right {
            display: flex;
            gap: 12px;
        }

        /* ========== è¾“å…¥å¼¹çª— ========== */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            backdrop-filter: blur(4px);
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 16px;
            padding: 28px;
            width: 400px;
            max-width: 90%;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 24px;
        }

        .modal-header h3 {
            font-size: 18px;
            font-weight: 600;
        }

        .modal-close {
            background: none;
            border: none;
            font-size: 24px;
            color: rgba(255, 255, 255, 0.5);
            cursor: pointer;
            line-height: 1;
            transition: color 0.2s;
        }

        .modal-close:hover {
            color: #fff;
        }

        .modal-actions {
            display: flex;
            gap: 12px;
            margin-top: 24px;
        }

        .modal-actions .btn {
            flex: 1;
        }

        /* ========== ç©ºçŠ¶æ€ ========== */
        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: rgba(255, 255, 255, 0.5);
        }

        .empty-state .icon {
            font-size: 48px;
            margin-bottom: 16px;
        }

        .empty-state p {
            margin-bottom: 20px;
        }

        /* ========== åŠ è½½åŠ¨ç”» ========== */
        .loading {
            display: inline-block;
            width: 16px;
            height: 16px;
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-top-color: #fff;
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
            margin-right: 8px;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* ========== å¿«é€Ÿé€‰æ‹©æ ·å¼ ========== */
        .quick-select-section {
            margin-bottom: 16px;
        }

        .section-label {
            display: block;
            margin-bottom: 10px;
            font-size: 14px;
            color: rgba(255, 255, 255, 0.7);
        }

        .quick-select-list {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            min-height: 40px;
            padding: 12px;
            background: rgba(0, 0, 0, 0.2);
            border-radius: 10px;
        }

        .quick-select-btn {
            padding: 8px 16px;
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 20px;
            color: #fff;
            font-size: 13px;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .quick-select-btn:hover {
            background: linear-gradient(135deg, #667eea, #764ba2);
            border-color: transparent;
            transform: translateY(-1px);
        }

        .quick-select-btn.selected {
            background: linear-gradient(135deg, #00d9a5, #00b894);
            border-color: transparent;
        }

        .quick-select-btn.disabled {
            opacity: 0.4;
            cursor: not-allowed;
            text-decoration: line-through;
        }

        .quick-select-btn.disabled:hover {
            background: rgba(255, 255, 255, 0.1);
            border-color: rgba(255, 255, 255, 0.2);
            transform: none;
        }

        .empty-hint {
            color: rgba(255, 255, 255, 0.4);
            font-size: 13px;
            font-style: italic;
        }

        .divider {
            display: flex;
            align-items: center;
            margin: 16px 0;
            color: rgba(255, 255, 255, 0.4);
            font-size: 12px;
        }

        .divider::before,
        .divider::after {
            content: '';
            flex: 1;
            height: 1px;
            background: rgba(255, 255, 255, 0.1);
        }

        .divider span {
            padding: 0 12px;
        }

        /* ========== éšè— ========== */
        .hidden { display: none !important; }

        /* ========== è¿”å›é“¾æ¥ ========== */
        .back-link {
            color: rgba(255, 255, 255, 0.5);
            text-decoration: none;
            font-size: 14px;
            display: inline-flex;
            align-items: center;
            gap: 6px;
            transition: color 0.2s;
        }

        .back-link:hover {
            color: #fff;
        }
    </style>
</head>
<body>
    <!-- ç™»å½•é¡µé¢ -->
    <div id="loginPage">
        <div class="login-container">
            <div class="card login-card">
                <div class="login-logo">ğŸ”</div>
                <h2 class="login-title">ç®¡ç†å‘˜ç™»å½•</h2>
                <p class="login-subtitle">è¯·è¾“å…¥ç®¡ç†å‘˜å¯†ç ä»¥ç»§ç»­</p>
                
                <div class="message" id="loginMessage"></div>
                
                <form onsubmit="handleAdminLogin(event)">
                    <div class="form-group">
                        <label>ç®¡ç†å‘˜å¯†ç </label>
                        <input type="password" id="adminPassword" placeholder="è¯·è¾“å…¥å¯†ç " required autocomplete="off">
                    </div>
                    <button type="submit" class="btn btn-primary submit-btn" id="loginBtn">
                        ç™»å½•
                    </button>
                </form>
                
                <div style="margin-top: 24px;">
                    <a href="/" class="back-link">â† è¿”å›é¦–é¡µ</a>
                </div>
            </div>
        </div>
    </div>

    <!-- ç®¡ç†é¡µé¢ -->
    <div id="adminPage" class="hidden">
        <!-- å¤´éƒ¨ -->
        <header class="header">
            <h1>
                CUMS ç®¡ç†æ§åˆ¶å°
                <span class="badge">Admin</span>
            </h1>
            <div class="user-info">
                <a href="/" class="back-link">â† è¿”å›é¦–é¡µ</a>
                <button class="btn btn-secondary btn-small" onclick="logout()">é€€å‡ºç™»å½•</button>
            </div>
        </header>

        <!-- ä¸»å†…å®¹ -->
        <main class="main">
            <div class="card">
                <div class="action-bar">
                    <div class="action-bar-left">
                        <h2 class="card-title" style="margin-bottom: 0;">ğŸ“š ç§‘ç›®ç®¡ç†</h2>
                    </div>
                    <div class="action-bar-right">
                        <button class="btn btn-secondary" onclick="refreshConfig()">ğŸ”„ åˆ·æ–°</button>
                        <button class="btn btn-success" onclick="saveConfig()">ğŸ’¾ ä¿å­˜é…ç½®</button>
                    </div>
                </div>

                <div class="message" id="adminMessage"></div>

                <!-- ç§‘ç›®åˆ—è¡¨ -->
                <div class="subject-list" id="subjectList">
                    <!-- åŠ¨æ€ç”Ÿæˆ -->
                </div>

                <!-- æ·»åŠ ç§‘ç›® -->
                <div class="add-subject-area">
                    <div class="add-form">
                        <div class="form-group">
                            <label>æ·»åŠ æ–°ç§‘ç›®</label>
                            <input type="text" id="newSubjectName" placeholder="è¾“å…¥ç§‘ç›®åç§°">
                        </div>
                        <button class="btn btn-primary" onclick="addSubject()">+ æ·»åŠ ç§‘ç›®</button>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- è¾“å…¥å¼¹çª— -->
    <div class="modal" id="inputModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="modalTitle">æ·»åŠ </h3>
                <button class="modal-close" onclick="hideModal()">&times;</button>
            </div>
            <div class="form-group">
                <label id="modalLabel">åç§°</label>
                <input type="text" id="modalInput" placeholder="è¯·è¾“å…¥">
            </div>
            <div class="modal-actions">
                <button class="btn btn-secondary" onclick="hideModal()">å–æ¶ˆ</button>
                <button class="btn btn-primary" id="modalConfirmBtn" onclick="confirmModal()">ç¡®å®š</button>
            </div>
        </div>
    </div>

    <!-- ç­çº§é€‰æ‹©å¼¹çª— -->
    <div class="modal" id="classModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>æ·»åŠ ç­çº§</h3>
                <button class="modal-close" onclick="hideClassModal()">&times;</button>
            </div>
            
            <!-- å¿«é€Ÿé€‰æ‹©åŒºåŸŸ -->
            <div class="quick-select-section" id="quickSelectSection">
                <label class="section-label">å¿«é€Ÿé€‰æ‹©å·²æœ‰ç­çº§</label>
                <div class="quick-select-list" id="existingClassList">
                    <!-- åŠ¨æ€ç”Ÿæˆ -->
                </div>
            </div>
            
            <!-- åˆ†éš”çº¿ -->
            <div class="divider" id="classDivider">
                <span>æˆ–è€…</span>
            </div>
            
            <!-- æ‰‹åŠ¨è¾“å…¥åŒºåŸŸ -->
            <div class="form-group">
                <label>è¾“å…¥æ–°ç­çº§åç§°</label>
                <input type="text" id="newClassInput" placeholder="å¦‚ï¼šä¸‰ç­">
            </div>
            
            <div class="modal-actions">
                <button class="btn btn-secondary" onclick="hideClassModal()">å–æ¶ˆ</button>
                <button class="btn btn-primary" onclick="confirmAddClass()">ç¡®å®š</button>
            </div>
        </div>
    </div>

    <script>
        // ==================== å…¨å±€çŠ¶æ€ ====================
        let adminToken = null;
        let configData = null;
        let pendingChanges = false;
        let modalCallback = null;

        // ==================== å·¥å…·å‡½æ•° ====================

        // HTML è½¬ä¹‰å‡½æ•°ï¼Œé˜²æ­¢ XSS æ”»å‡»
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // ==================== åˆå§‹åŒ– ====================

        async function init() {
            // æ£€æŸ¥æ˜¯å¦æœ‰ä¿å­˜çš„ä»¤ç‰Œ
            const savedToken = sessionStorage.getItem('admin_token');
            if (savedToken) {
                adminToken = savedToken;
                const valid = await verifyToken();
                if (valid) {
                    showAdminPage();
                    await loadConfig();
                } else {
                    sessionStorage.removeItem('admin_token');
                    showLoginPage();
                }
            }
        }

        // éªŒè¯ä»¤ç‰Œ
        async function verifyToken() {
            try {
                const res = await fetch('/api/v1/admin/config', {
                    method: 'GET',
                    headers: { 'X-Admin-Token': adminToken }
                });
                const data = await res.json();
                return data.success;
            } catch (e) {
                return false;
            }
        }

        // ==================== ç™»å½•å¤„ç† ====================

        async function handleAdminLogin(e) {
            e.preventDefault();
            
            const password = document.getElementById('adminPassword').value;
            const loginBtn = document.getElementById('loginBtn');
            const message = document.getElementById('loginMessage');
            
            loginBtn.disabled = true;
            loginBtn.innerHTML = '<span class="loading"></span>ç™»å½•ä¸­...';
            
            try {
                const res = await fetch('/api/v1/admin/login', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ password })
                });
                const data = await res.json();
                
                if (data.success) {
                    adminToken = data.token;
                    sessionStorage.setItem('admin_token', adminToken);
                    showAdminPage();
                    await loadConfig();
                } else {
                    message.textContent = data.message || 'ç™»å½•å¤±è´¥';
                    message.className = 'message error';
                }
            } catch (e) {
                message.textContent = 'ç™»å½•å¤±è´¥ï¼Œè¯·é‡è¯•';
                message.className = 'message error';
            } finally {
                loginBtn.disabled = false;
                loginBtn.textContent = 'ç™»å½•';
            }
        }

        function logout() {
            if (pendingChanges && !confirm('æœ‰æœªä¿å­˜çš„æ›´æ”¹ï¼Œç¡®å®šè¦é€€å‡ºå—ï¼Ÿ')) {
                return;
            }
            adminToken = null;
            sessionStorage.removeItem('admin_token');
            showLoginPage();
        }

        // ==================== é¡µé¢åˆ‡æ¢ ====================

        function showLoginPage() {
            document.getElementById('loginPage').classList.remove('hidden');
            document.getElementById('adminPage').classList.add('hidden');
        }

        function showAdminPage() {
            document.getElementById('loginPage').classList.add('hidden');
            document.getElementById('adminPage').classList.remove('hidden');
        }

        // ==================== é…ç½®åŠ è½½ ====================

        async function loadConfig() {
            try {
                const res = await fetch('/api/v1/admin/config', {
                    method: 'GET',
                    headers: { 'X-Admin-Token': adminToken }
                });
                const data = await res.json();
                
                if (data.success) {
                    configData = data.data;
                    renderSubjects();
                } else {
                    showMessage('adminMessage', data.message || 'åŠ è½½é…ç½®å¤±è´¥', 'error');
                }
            } catch (e) {
                showMessage('adminMessage', 'åŠ è½½é…ç½®å¤±è´¥', 'error');
            }
        }

        async function refreshConfig() {
            if (pendingChanges && !confirm('æœ‰æœªä¿å­˜çš„æ›´æ”¹ï¼Œåˆ·æ–°å°†ä¸¢å¤±è¿™äº›æ›´æ”¹ï¼Œç¡®å®šè¦ç»§ç»­å—ï¼Ÿ')) {
                return;
            }
            pendingChanges = false;
            await loadConfig();
            showMessage('adminMessage', 'é…ç½®å·²åˆ·æ–°', 'success');
        }

        // ==================== é…ç½®ä¿å­˜ ====================

        async function saveConfig() {
            try {
                const res = await fetch('/api/v1/admin/config', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-Admin-Token': adminToken
                    },
                    body: JSON.stringify({ subjects: configData.subjects })
                });
                const data = await res.json();
                
                if (data.success) {
                    pendingChanges = false;
                    showMessage('adminMessage', 'é…ç½®å·²ä¿å­˜', 'success');
                } else {
                    showMessage('adminMessage', data.message || 'ä¿å­˜å¤±è´¥', 'error');
                }
            } catch (e) {
                showMessage('adminMessage', 'ä¿å­˜å¤±è´¥', 'error');
            }
        }

        // ==================== æ¸²æŸ“ç§‘ç›®åˆ—è¡¨ ====================

        function renderSubjects() {
            const container = document.getElementById('subjectList');
            
            if (!configData || !configData.subjects || Object.keys(configData.subjects).length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="icon">ğŸ“­</div>
                        <p>æš‚æ— ç§‘ç›®é…ç½®</p>
                        <p style="font-size: 14px;">åœ¨ä¸‹æ–¹æ·»åŠ æ–°ç§‘ç›®å¼€å§‹é…ç½®</p>
                    </div>
                `;
                return;
            }

            const subjectColors = ['#667eea', '#e94560', '#00d9a5', '#ffd93d', '#6c5ce7', '#00cec9'];
            let colorIndex = 0;

            container.innerHTML = Object.entries(configData.subjects).map(([name, data]) => {
                const color = subjectColors[colorIndex++ % subjectColors.length];
                const escapedName = escapeHtml(name);
                return `
                    <div class="subject-item" data-subject="${escapedName}">
                        <div class="subject-header">
                            <div class="subject-name">
                                <span class="icon" style="background: linear-gradient(135deg, ${color}, ${color}dd);">ğŸ“–</span>
                                ${escapedName}
                            </div>
                            <div class="subject-actions">
                                <button class="btn btn-secondary btn-icon" onclick="editSubjectName('${escapedName}')" title="ç¼–è¾‘åç§°">âœï¸</button>
                                <button class="btn btn-danger btn-icon" onclick="deleteSubject('${escapedName}')" title="åˆ é™¤ç§‘ç›®">ğŸ—‘ï¸</button>
                            </div>
                        </div>
                        <div class="subject-content">
                            <div class="content-section">
                                <h4>ç­çº§</h4>
                                <div class="tag-list">
                                    ${data.classes.map(c => `
                                        <span class="tag">
                                            ${escapeHtml(c)}
                                            <button class="remove-btn" onclick="removeClass('${escapedName}', '${escapeHtml(c)}')">&times;</button>
                                        </span>
                                    `).join('')}
                                    <button class="add-tag-btn" onclick="addClass('${escapedName}')">+ æ·»åŠ ç­çº§</button>
                                </div>
                            </div>
                            <div class="content-section">
                                <h4>ä½œä¸š</h4>
                                <div class="tag-list">
                                    ${data.homeworks.map(h => `
                                        <span class="tag">
                                            ${escapeHtml(h)}
                                            <button class="remove-btn" onclick="removeHomework('${escapedName}', '${escapeHtml(h)}')">&times;</button>
                                        </span>
                                    `).join('')}
                                    <button class="add-tag-btn" onclick="addHomework('${escapedName}')">+ æ·»åŠ ä½œä¸š</button>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        // ==================== ç§‘ç›®æ“ä½œ ====================

        function addSubject() {
            const input = document.getElementById('newSubjectName');
            const name = input.value.trim();
            
            if (!name) {
                showMessage('adminMessage', 'è¯·è¾“å…¥ç§‘ç›®åç§°', 'error');
                return;
            }
            
            if (configData.subjects[name]) {
                showMessage('adminMessage', 'ç§‘ç›®å·²å­˜åœ¨', 'error');
                return;
            }
            
            configData.subjects[name] = {
                classes: [],
                homeworks: []
            };
            
            input.value = '';
            pendingChanges = true;
            renderSubjects();
            showMessage('adminMessage', `ç§‘ç›® "${name}" å·²æ·»åŠ `, 'success');
        }

        function editSubjectName(oldName) {
            showModal('ç¼–è¾‘ç§‘ç›®åç§°', 'æ–°åç§°', oldName, (newName) => {
                if (!newName || newName === oldName) return;
                
                if (configData.subjects[newName]) {
                    showMessage('adminMessage', 'ç§‘ç›®å·²å­˜åœ¨', 'error');
                    return;
                }
                
                configData.subjects[newName] = configData.subjects[oldName];
                delete configData.subjects[oldName];
                pendingChanges = true;
                renderSubjects();
            });
        }

        function deleteSubject(name) {
            if (!confirm(`ç¡®å®šè¦åˆ é™¤ç§‘ç›® "${name}" å—ï¼Ÿ\nè¯¥ç§‘ç›®ä¸‹çš„æ‰€æœ‰ç­çº§å’Œä½œä¸šé…ç½®éƒ½å°†è¢«åˆ é™¤ã€‚`)) {
                return;
            }
            
            delete configData.subjects[name];
            pendingChanges = true;
            renderSubjects();
            showMessage('adminMessage', `ç§‘ç›® "${name}" å·²åˆ é™¤`, 'success');
        }

        // ==================== ç­çº§æ“ä½œ ====================

        let currentAddClassSubject = null; // å½“å‰æ­£åœ¨æ·»åŠ ç­çº§çš„ç§‘ç›®

        // è·å–æ‰€æœ‰å·²å­˜åœ¨çš„ç­çº§åˆ—è¡¨ï¼ˆå»é‡ï¼‰
        function getAllExistingClasses() {
            const classSet = new Set();
            if (configData && configData.subjects) {
                Object.values(configData.subjects).forEach(subject => {
                    subject.classes.forEach(c => classSet.add(c));
                });
            }
            return Array.from(classSet).sort();
        }

        // æ˜¾ç¤ºç­çº§é€‰æ‹©å¼¹çª—
        function showClassModal(subjectName) {
            currentAddClassSubject = subjectName;
            const subject = configData.subjects[subjectName];
            const existingClasses = getAllExistingClasses();
            const currentSubjectClasses = subject.classes;
            
            // ç”Ÿæˆå¿«é€Ÿé€‰æ‹©åˆ—è¡¨
            const listContainer = document.getElementById('existingClassList');
            const quickSelectSection = document.getElementById('quickSelectSection');
            const divider = document.getElementById('classDivider');
            
            if (existingClasses.length === 0) {
                // æ²¡æœ‰å·²æœ‰ç­çº§ï¼Œéšè—å¿«é€Ÿé€‰æ‹©åŒºåŸŸ
                quickSelectSection.style.display = 'none';
                divider.style.display = 'none';
            } else {
                quickSelectSection.style.display = 'block';
                divider.style.display = 'flex';
                
                listContainer.innerHTML = existingClasses.map(className => {
                    const isInCurrentSubject = currentSubjectClasses.includes(className);
                    return `
                        <button class="quick-select-btn ${isInCurrentSubject ? 'disabled' : ''}" 
                                onclick="${isInCurrentSubject ? '' : `selectExistingClass('${className}', '${subjectName}')`}"
                                title="${isInCurrentSubject ? 'è¯¥ç­çº§å·²æ·»åŠ åˆ°æ­¤ç§‘ç›®' : 'ç‚¹å‡»å¿«é€Ÿæ·»åŠ '}">
                            ${className}${isInCurrentSubject ? ' âœ“' : ''}
                        </button>
                    `;
                }).join('');
            }
            
            // æ¸…ç©ºè¾“å…¥æ¡†
            document.getElementById('newClassInput').value = '';
            
            // æ˜¾ç¤ºå¼¹çª—
            document.getElementById('classModal').classList.add('active');
            document.getElementById('newClassInput').focus();
        }

        // éšè—ç­çº§é€‰æ‹©å¼¹çª—
        function hideClassModal() {
            document.getElementById('classModal').classList.remove('active');
            currentAddClassSubject = null;
        }

        // å¿«é€Ÿé€‰æ‹©å·²æœ‰ç­çº§
        function selectExistingClass(className, subjectName) {
            const targetSubject = subjectName || currentAddClassSubject;
            if (!targetSubject) return;
            
            const subject = configData.subjects[targetSubject];
            if (subject.classes.includes(className)) {
                showMessage('adminMessage', 'ç­çº§å·²å­˜åœ¨', 'error');
                return;
            }
            
            subject.classes.push(className);
            pendingChanges = true;
            hideClassModal();
            renderSubjects();
            showMessage('adminMessage', `ç­çº§ "${className}" å·²æ·»åŠ åˆ° "${targetSubject}"`, 'success');
        }

        // ç¡®è®¤æ·»åŠ ç­çº§ï¼ˆæ‰‹åŠ¨è¾“å…¥ï¼‰
        function confirmAddClass() {
            const className = document.getElementById('newClassInput').value.trim();
            
            if (!className) {
                showMessage('adminMessage', 'è¯·è¾“å…¥ç­çº§åç§°', 'error');
                return;
            }
            
            if (!currentAddClassSubject) return;
            
            const subject = configData.subjects[currentAddClassSubject];
            if (subject.classes.includes(className)) {
                showMessage('adminMessage', 'ç­çº§å·²å­˜åœ¨', 'error');
                return;
            }
            
            subject.classes.push(className);
            pendingChanges = true;
            hideClassModal();
            renderSubjects();
            showMessage('adminMessage', `ç­çº§ "${className}" å·²æ·»åŠ åˆ° "${currentAddClassSubject}"`, 'success');
        }

        // åŸæ¥çš„ addClass å‡½æ•°æ”¹ä¸ºè°ƒç”¨æ–°å¼¹çª—
        function addClass(subjectName) {
            showClassModal(subjectName);
        }

        function removeClass(subjectName, className) {
            if (!confirm(`ç¡®å®šè¦ä» "${subjectName}" ä¸­ç§»é™¤ç­çº§ "${className}" å—ï¼Ÿ`)) {
                return;
            }
            
            const subject = configData.subjects[subjectName];
            subject.classes = subject.classes.filter(c => c !== className);
            pendingChanges = true;
            renderSubjects();
        }

        // ==================== ä½œä¸šæ“ä½œ ====================

        function addHomework(subjectName) {
            showModal('æ·»åŠ ä½œä¸š', 'ä½œä¸šåç§°', '', (homeworkName) => {
                if (!homeworkName) return;
                
                const subject = configData.subjects[subjectName];
                if (subject.homeworks.includes(homeworkName)) {
                    showMessage('adminMessage', 'ä½œä¸šå·²å­˜åœ¨', 'error');
                    return;
                }
                
                subject.homeworks.push(homeworkName);
                pendingChanges = true;
                renderSubjects();
            });
        }

        function removeHomework(subjectName, homeworkName) {
            if (!confirm(`ç¡®å®šè¦ä» "${subjectName}" ä¸­ç§»é™¤ä½œä¸š "${homeworkName}" å—ï¼Ÿ`)) {
                return;
            }
            
            const subject = configData.subjects[subjectName];
            subject.homeworks = subject.homeworks.filter(h => h !== homeworkName);
            pendingChanges = true;
            renderSubjects();
        }

        // ==================== å¼¹çª— ====================

        function showModal(title, label, defaultValue, callback) {
            document.getElementById('modalTitle').textContent = title;
            document.getElementById('modalLabel').textContent = label;
            document.getElementById('modalInput').value = defaultValue || '';
            modalCallback = callback;
            document.getElementById('inputModal').classList.add('active');
            document.getElementById('modalInput').focus();
        }

        function hideModal() {
            document.getElementById('inputModal').classList.remove('active');
            modalCallback = null;
        }

        function confirmModal() {
            const value = document.getElementById('modalInput').value.trim();
            if (modalCallback) {
                modalCallback(value);
            }
            hideModal();
        }

        // ==================== å·¥å…·å‡½æ•° ====================

        function showMessage(elementId, text, type) {
            const element = document.getElementById(elementId);
            element.textContent = text;
            element.className = `message ${type}`;
            
            setTimeout(() => {
                element.className = 'message';
            }, 3000);
        }

        // ==================== äº‹ä»¶ç»‘å®š ====================

        // ç‚¹å‡»å¼¹çª—èƒŒæ™¯å…³é—­
        document.getElementById('inputModal').addEventListener('click', function(e) {
            if (e.target === this) hideModal();
        });

        // ç‚¹å‡»ç­çº§å¼¹çª—èƒŒæ™¯å…³é—­
        document.getElementById('classModal').addEventListener('click', function(e) {
            if (e.target === this) hideClassModal();
        });

        // Enter é”®ç¡®è®¤å¼¹çª—
        document.getElementById('modalInput').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                confirmModal();
            }
        });

        // Enter é”®ç¡®è®¤ç­çº§å¼¹çª—
        document.getElementById('newClassInput').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                confirmAddClass();
            }
        });

        // ç¦»å¼€é¡µé¢æç¤º
        window.addEventListener('beforeunload', function(e) {
            if (pendingChanges) {
                e.preventDefault();
                e.returnValue = '';
            }
        });

        // åˆå§‹åŒ–
        init();
    </script>
</body>
</html>
